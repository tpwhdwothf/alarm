# ì‹¤ì„œë²„ ë°°í¬ ê°€ì´ë“œ (Oracle Cloud + ZIP ë°©ì‹)

PCì—ì„œ ì½”ë“œë¥¼ ìˆ˜ì •í•œ ë’¤ ì‹¤ì„œë²„ì— ë°˜ì˜í•˜ëŠ” **ì „ì²´ ì ˆì°¨**ë¥¼ ì •ë¦¬í•œ ë¬¸ì„œì…ë‹ˆë‹¤.  
ZIP ë°©ì‹(wget) ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.

---

## ì‚¬ì „ ì¤€ë¹„

- GitHub ì €ì¥ì†Œê°€ **public** ì„¤ì •
- SSH í‚¤(`alarm-bot.key`)ë¡œ ì„œë²„ ì ‘ì† ê°€ëŠ¥
- ì„œë²„ IP ì£¼ì†Œ í™•ì¸
- **Supabase ë§ˆì´ê·¸ë ˆì´ì…˜** (ì•„ë˜ "Supabase ë§ˆì´ê·¸ë ˆì´ì…˜" ì„¹ì…˜ í™•ì¸)

---

## 1ë‹¨ê³„: PCì—ì„œ GitHubì— ì˜¬ë¦¬ê¸°

### 1-1. í‚¤ íŒŒì¼ì´ ìˆëŠ” í´ë”ë¡œ ì´ë™

```powershell
cd C:\Users\tpwhd\OneDrive\Desktop\ì½”ê¸¸ë™
```

> `alarm-bot.key`ê°€ ìˆëŠ” í´ë” ê¸°ì¤€ì…ë‹ˆë‹¤. í”„ë¡œì íŠ¸(`.git`)ê°€ `alarm` í•˜ìœ„ í´ë”ì— ìˆìœ¼ë©´ `cd alarm` ì¶”ê°€ë¡œ ì‹¤í–‰í•˜ì„¸ìš”.

### 1-2. ë³€ê²½ ì‚¬í•­ ì»¤ë°‹ & í‘¸ì‹œ

```powershell
git add .
git commit -m "ë³€ê²½ ë‚´ìš© ìš”ì•½"
git push origin main
```

> ê¸°ë³¸ ë¸Œëœì¹˜ê°€ `master`ë©´ `git push origin master`ë¡œ ì‹¤í–‰í•˜ì„¸ìš”.

---

## 2ë‹¨ê³„: ì„œë²„ SSH ì ‘ì†

**ìƒˆ PowerShell ì°½**ì„ ì—´ê³ :

```powershell
cd C:\Users\tpwhd\OneDrive\Desktop\ì½”ê¸¸ë™
ssh -i alarm-bot.key opc@161.33.212.251
```

> `alarm-bot.key`ì™€ ì„œë²„ IPë¥¼ ë³¸ì¸ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”.

---

## 3ë‹¨ê³„ ì „: PM2 í”„ë¡œì„¸ìŠ¤ ì¤‘ì§€ (1GB RAM ì„œë²„ í•„ìˆ˜)

1GB RAM í™˜ê²½ì—ì„œëŠ” `npm install`ê³¼ `npm run build` ì‹œ ë©”ëª¨ë¦¬ë¥¼ ë§ì´ ì‚¬ìš©í•©ë‹ˆë‹¤.  
ë´‡Â·ì›Œì»¤ê°€ ê³„ì† ëŒì•„ê°€ë©´ OOMìœ¼ë¡œ ì„œë²„ê°€ ë‹¤ìš´ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, **ë°°í¬ ì „ì— ë°˜ë“œì‹œ ì¤‘ì§€**í•˜ì„¸ìš”.

```bash
npx pm2 stop all
```

- `bot`, `worker-kis`ê°€ ì¤‘ì§€ë˜ë©° ë©”ëª¨ë¦¬ê°€ í™•ë³´ë©ë‹ˆë‹¤.
- ì´í›„ ì„¤ì¹˜Â·ë¹Œë“œ ë‹¨ê³„ì—ì„œ OOM ìœ„í—˜ì´ ì¤„ì–´ë“­ë‹ˆë‹¤.

---

## 3ë‹¨ê³„: ì„œë²„ì—ì„œ ìµœì‹  ì½”ë“œ ë°›ê¸° (ZIP ë°©ì‹)

### 3-1. í™ˆ í´ë”ë¡œ ì´ë™

```bash
cd ~
```

### 3-2. GitHubì—ì„œ ZIP ë‹¤ìš´ë¡œë“œ

```bash
wget https://github.com/tpwhdwothf/alarm/archive/refs/heads/main.zip -O alarm-latest.zip
```

> `ë³¸ì¸ì•„ì´ë””`, `ì €ì¥ì†Œì´ë¦„`ì„ ì‹¤ì œ GitHub ì£¼ì†Œì— ë§ê²Œ ë°”ê¾¸ì„¸ìš”.  
> ë¸Œëœì¹˜ê°€ `master`ë©´ `master.zip`ìœ¼ë¡œ ë°”ê¾¸ì„¸ìš”.

### 3-3. ì••ì¶• í•´ì œ

```bash
unzip -o alarm-latest.zip
```

- ì••ì¶• í•´ì œ ì‹œ `ì €ì¥ì†Œì´ë¦„-main` í´ë”ê°€ ìƒì„±ë©ë‹ˆë‹¤ (ì˜ˆ: `alarm-main`)

---

## 4ë‹¨ê³„: í´ë” ì •ë¦¬

### 4-1. ê¸°ì¡´ alarm í´ë” ì‚­ì œ ë° êµì²´

```bash
rm -rf alarm
mv alarm-main alarm
```

> í’€ë¦° í´ë” ì´ë¦„ì´ `alarm-main`ì´ ì•„ë‹ˆë©´ `ì €ì¥ì†Œì´ë¦„-main`ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”.

### 4-2. í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™

```bash
cd ~/alarm
```

### 4-3. ë‚´ìš© í™•ì¸

```bash
ls -la
```

- `package.json`, `src`, `.env` ë“±ì´ ë³´ì´ë©´ ì •ìƒì…ë‹ˆë‹¤.

---

## 5ë‹¨ê³„: .env í™•ì¸

### 5-1. TELEGRAM_ADMIN_IDS í™•ì¸

```bash
grep TELEGRAM_ADMIN_IDS .env
```

- í•œ ì¤„ë¡œ ë‚˜ì˜¤ë©´ OK
- ì—†ìœ¼ë©´ ì•„ë˜ì²˜ëŸ¼ ì¶”ê°€:

```bash
nano .env
```

íŒŒì¼ ë§¨ ì•„ë˜ì— ì¶”ê°€:

```
TELEGRAM_ADMIN_IDS=ë³¸ì¸í…”ë ˆê·¸ë¨ìˆ«ìID
```

- ì €ì¥: `Ctrl + O` â†’ Enter
- ì¢…ë£Œ: `Ctrl + X`

### 5-2. ê¸°ì¡´ .envë¥¼ ë‹¤ë¥¸ í´ë”ì—ì„œ ë³µì‚¬í•´ì•¼ í•  ë•Œ

```bash
cp ~/alarm-backup/.env ./
```

> ë˜ëŠ” `alarm-old` ë“± ê¸°ì¡´ì— .envê°€ ìˆë˜ í´ë” ê²½ë¡œë¡œ ìˆ˜ì •í•˜ì„¸ìš”.

---

## 6ë‹¨ê³„: ë¹Œë“œ

### 6-1. ì˜ì¡´ì„± ì„¤ì¹˜

```bash
cd ~/alarm
npm install
```

### 6-2. ê¶Œí•œ ì˜¤ë¥˜ê°€ ë‚  ë•Œ (tsc: Permission denied)

```bash
chmod +x node_modules/.bin/*
```

### 6-3. TypeScript ë¹Œë“œ

```bash
npm run build
```

- `dist/` í´ë”ê°€ ìƒì„±ë˜ê±°ë‚˜ ê°±ì‹ ë˜ë©´ ì„±ê³µì…ë‹ˆë‹¤.

---

## 7ë‹¨ê³„: PM2 ë‹¤ì‹œ ì‹œì‘

### 7-1. ì¤‘ì§€í–ˆë˜ í”„ë¡œì„¸ìŠ¤ ë‹¤ì‹œ ì‹œì‘

```bash
cd ~/alarm
npx pm2 start all
npx pm2 save
```

> 3ë‹¨ê³„ ì „ì—ì„œ `pm2 stop all`ë¡œ ì¤‘ì§€í–ˆë˜ `bot`, `worker-kis`ë¥¼ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.  
> ìµœì´ˆ ë°°í¬ê±°ë‚˜ PM2 ëª©ë¡ì´ ë¹„ì–´ ìˆìœ¼ë©´, ì•„ë˜ì²˜ëŸ¼ ìˆ˜ë™ìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”:  
> `npx pm2 start dist/bot/index.js --name bot`  
> `npx pm2 start dist/worker/kisPriceWorker.js --name worker-kis`  
> `npx pm2 save`

### 7-2. ìƒíƒœ í™•ì¸

```bash
npx pm2 status
```

- `bot`, `worker-kis` ë‘˜ ë‹¤ **online**ì´ë©´ ì •ìƒì…ë‹ˆë‹¤.

---

## ë©”ëª¨ë¦¬ ë¶€ì¡± ì‹œ ì°¸ê³  (1GB RAM)

| ìƒí™© | ëŒ€ì‘ |
|------|------|
| ë°°í¬ ì¤‘ ì„œë²„ ë‹¤ìš´ | 3ë‹¨ê³„ ì „ì— `npx pm2 stop all` ì‹¤í–‰ |
| ì„¤ì¹˜Â·ë¹Œë“œ ì¤‘ OOM | ë´‡Â·ì›Œì»¤ ì¤‘ì§€ í›„ `npm install`, `npm run build` ì§„í–‰ |

---

## 8ë‹¨ê³„: ë¡œê·¸ í™•ì¸ (ë¬¸ì œê°€ ìˆì„ ë•Œ)

### 8-1. ë´‡ ë¡œê·¸

```bash
npx pm2 logs bot
```

### 8-2. ì›Œì»¤ ë¡œê·¸

```bash
npx pm2 logs worker-kis
```

### 8-3. ìµœê·¼ 30ì¤„ë§Œ ë³´ê¸°

```bash
npx pm2 logs bot --lines 30 --nostream
```

---

## 9ë‹¨ê³„: ë¶€íŒ… ì‹œ ìë™ ì‹¤í–‰ (ìµœì´ˆ 1íšŒë§Œ)

ì„œë²„ ì¬ë¶€íŒ… í›„ì—ë„ ë´‡ì´ ìë™ìœ¼ë¡œ ì¼œì§€ê²Œ í•˜ë ¤ë©´:

```bash
npx pm2 startup
```

ì¶œë ¥ë˜ëŠ” `sudo env PATH=... pm2 startup ...` ëª…ë ¹ì„ **ê·¸ëŒ€ë¡œ ë³µì‚¬í•´ì„œ** ì‹¤í–‰í•˜ì„¸ìš”.

---

## ìš”ì•½ ì²´í¬ë¦¬ìŠ¤íŠ¸

| ìˆœì„œ | ì‘ì—… | ëª…ë ¹ |
|------|------|------|
| 1 | PCì—ì„œ push | `git add . && git commit -m "..." && git push origin main` |
| 2 | ì„œë²„ ì ‘ì† | `ssh -i alarm-bot.key opc@ì„œë²„IP` |
| 3 | **PM2 ì¤‘ì§€ (1GB í•„ìˆ˜)** | `npx pm2 stop all` |
| 4 | ZIP ë‹¤ìš´ë¡œë“œ | `wget https://github.com/ì•„ì´ë””/ì €ì¥ì†Œ/archive/refs/heads/main.zip -O alarm-latest.zip` |
| 5 | ì••ì¶• í•´ì œ | `unzip -o alarm-latest.zip` |
| 6 | í´ë” ì •ë¦¬ | `rm -rf alarm && mv alarm-main alarm` |
| 7 | ì„¤ì¹˜Â·ë¹Œë“œ | `cd ~/alarm && npm install && npm run build` |
| 8 | PM2 ì¬ì‹œì‘ | `npx pm2 start all` â†’ `npx pm2 save` |
| 9 | í™•ì¸ | `npx pm2 status` |

---

## ìì£¼ í•˜ëŠ” ì‹¤ìˆ˜

### 1. `cd ~/alarm` ì‹œ "No such file or directory"

- `alarm` í´ë”ê°€ ì•„ì§ ì—†ìŒ â†’ 4ë‹¨ê³„(í´ë” ì •ë¦¬)ë¶€í„° ë‹¤ì‹œ ì§„í–‰
- `ls ~` ë¡œ `alarm-main` ë“± í’€ë¦° í´ë” ì´ë¦„ í™•ì¸ í›„ `mv` ì§„í–‰

### 2. `tsc: Permission denied`

```bash
chmod +x node_modules/.bin/*
```

### 3. PM2 statusê°€ `errored`

- ë¡œê·¸ í™•ì¸: `npx pm2 logs bot`
- `ProcessContainerFork.js` ê´€ë ¨ ì—ëŸ¬ë©´ PM2 ì¬ì„¤ì¹˜ í›„ ì¬ì‹œì‘:

```bash
npm install --save-dev pm2
npx pm2 kill
npx pm2 start dist/bot/index.js --name bot
npx pm2 start dist/worker/kisPriceWorker.js --name worker-kis
npx pm2 save
```

### 4. .envì— ìƒˆ ë³€ìˆ˜ ì¶”ê°€ê°€ í•„ìš”í•  ë•Œ

```bash
nano .env
```

ì €ì¥ í›„ ë°˜ë“œì‹œ PM2 ì¬ì‹œì‘:

```bash
npx pm2 restart bot worker-kis
```

---

## Supabase ë§ˆì´ê·¸ë ˆì´ì…˜

ì½”ë“œ ë°°í¬ ì „/í›„ì— **Supabase SQL Editor**ì—ì„œ ì•„ë˜ SQLì„ í•œ ë²ˆì”© ì‹¤í–‰í•´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### pick_type ì»¬ëŸ¼ ì¶”ê°€ (í•„ìˆ˜)

`/ëª©ë¡`, `/ë“±ë¡` ì‚¬ìš© ì‹œ **"Could not find the 'pick_type' column"** ì˜¤ë¥˜ê°€ ë‚˜ë©´ ì•„ë˜ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.

```sql
alter table public.targets
  add column if not exists pick_type text default 'ë¬´ë£Œí”½';
```

### buy_price_range ì»¬ëŸ¼ ì¶”ê°€ (ë§¤ìˆ˜ê°€ ë“±ë¡ ì‹œ)

`/ë“±ë¡` ì‹œ ë§¤ìˆ˜ê°€(110000~220000)ë¥¼ ì…ë ¥í•˜ë ¤ë©´ ì•„ë˜ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.

```sql
alter table public.targets
  add column if not exists buy_price_range text;
```

### alert_groups í…Œì´ë¸” (í•„ìš” ì‹œ)

`/setgroup ê³µì§€ë°©`, `/setgroup VIP`, `/setgroup ì¼ë°˜ë°©` ê¸°ëŠ¥ì„ ì“°ë ¤ë©´ ì•„ë˜ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.

```sql
create table if not exists public.alert_groups (
  id uuid primary key default gen_random_uuid(),
  created_by text not null,
  group_chat_id text not null,
  role text not null check (role in ('NOTICE', 'VIP', 'GENERAL')),
  created_at timestamptz default now()
);

create unique index alert_groups_created_by_group_chat_id_idx
  on public.alert_groups(created_by, group_chat_id);
```

**ê¸°ì¡´ alert_groups í…Œì´ë¸”ì´ ìˆë‹¤ë©´** (GENERAL role ì¶”ê°€):

```sql
alter table public.alert_groups drop constraint if exists alert_groups_role_check;
alter table public.alert_groups add constraint alert_groups_role_check
  check (role in ('NOTICE', 'VIP', 'GENERAL'));
```

---

## ìì£¼ ë‚˜ì˜¤ëŠ” Supabase ì˜¤ë¥˜

### 1. "Could not find the 'pick_type' column of 'targets'"

- **ì›ì¸**: `targets` í…Œì´ë¸”ì— `pick_type` ì»¬ëŸ¼ ì—†ìŒ
- **í•´ê²°**: ìœ„ "pick_type ì»¬ëŸ¼ ì¶”ê°€" SQLì„ Supabase SQL Editorì—ì„œ ì‹¤í–‰

### 2. "/ëª©ë¡" ë˜ëŠ” "/ë“±ë¡" ì‹œ "ëª©ë¡/ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”"

- ìœ„ `pick_type` ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸
- Supabase SQL Editorì—ì„œ `select * from targets limit 1;` ì‹¤í–‰ í›„ í…Œì´ë¸”ì— `pick_type` ì»¬ëŸ¼ì´ ìˆëŠ”ì§€ í™•ì¸

---

## SSH ëŠê¹€ ì›ì¸ í™•ì¸

SSHê°€ ìì£¼ ëŠê¸¸ ë•Œ ì›ì¸ì„ ì¶”ì í•˜ë ¤ë©´ ì•„ë˜ ë¡œê¹…ì„ ì„¤ì •í•´ ë‘ì„¸ìš”.

> ğŸ“‹ **í™•ì¸ ë°©ë²• (ë¹„ê°œë°œììš©)**  
> ëŠê¸´ í›„ ë¡œê·¸ë¥¼ ì–´ë–»ê²Œ í™•ì¸í•˜ê³  í•´ì„í•˜ëŠ”ì§€ëŠ” [SSH_ëŠê¹€_í™•ì¸_ê°€ì´ë“œ.md](./SSH_ëŠê¹€_í™•ì¸_ê°€ì´ë“œ.md)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

### 1) ì‹œìŠ¤í…œ ìƒíƒœ ì£¼ê¸° ë¡œê¹… (ê¶Œì¥)

ë§¤ 3ë¶„ë§ˆë‹¤ ë©”ëª¨ë¦¬Â·ë¶€í•˜Â·SSH ì—°ê²° ìˆ˜ë¥¼ ë¡œê·¸ì— ë‚¨ê¹ë‹ˆë‹¤. ëŠê¸´ ì§ì „ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì„œë²„ì—ì„œ ì‹¤í–‰ (ZIP ë°°í¬ í›„ ~/alarm ì•ˆì— ìŠ¤í¬ë¦½íŠ¸ ìˆìŒ):**

```bash
mkdir -p ~/scripts
cp ~/alarm/scripts/server/ssh-debug-logger.sh ~/scripts/
chmod +x ~/scripts/ssh-debug-logger.sh
```

**cron ë“±ë¡ (3ë¶„ë§ˆë‹¤ ì‹¤í–‰):**

```bash
crontab -e
```

ì•„ë˜ í•œ ì¤„ ì¶”ê°€ (ê²½ë¡œëŠ” ì‹¤ì œ ê²½ë¡œë¡œ ìˆ˜ì •):

```
*/3 * * * * /home/opc/scripts/ssh-debug-logger.sh
```

**ëŠê¸´ í›„ ë‹¤ì‹œ ì ‘ì†í•´ì„œ í™•ì¸:**

```bash
tail -50 ~/ssh-debug.log
```

`mem=90%` ì´ìƒì´ê±°ë‚˜ `free`ê°€ 100MB ë¯¸ë§Œì´ì—ˆìœ¼ë©´ OOM ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤. `ssh=` ê°œìˆ˜ê°€ ê°‘ìê¸° ì¤„ì—ˆìœ¼ë©´ ì—°ê²° ëŠê¹€ ì‹œì ì„ ì¶”ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

### 2) sshd ìƒì„¸ ë¡œê·¸ (ëŠê¹€ ì‚¬ìœ  í™•ì¸)

SSHê°€ **ì™œ** ëŠê²¼ëŠ”ì§€(í´ë¼ì´ì–¸íŠ¸ ì¢…ë£Œ, íƒ€ì„ì•„ì›ƒ, ì„œë²„ ì¸¡ ì˜¤ë¥˜ ë“±) ìƒì„¸ ë¡œê·¸ë¥¼ ë‚¨ê¹ë‹ˆë‹¤.

**ì„œë²„ì—ì„œ (sudo í•„ìš”):**

```bash
# í˜„ì¬ LogLevel í™•ì¸
grep LogLevel /etc/ssh/sshd_config

# LogLevelì„ VERBOSEë¡œ ë³€ê²½
sudo sed -i 's/^#\?LogLevel.*/LogLevel VERBOSE/' /etc/ssh/sshd_config

# sshd ì¬ì‹œì‘ (ì ‘ì†ì´ ëŠê²¼ë‹¤ê°€ ë‹¤ì‹œ ì—°ê²°ë¨)
sudo systemctl restart sshd
```

> âš ï¸ `systemctl restart sshd` ì‹¤í–‰ ì‹œ í˜„ì¬ ì„¸ì…˜ì€ ëŠê¹ë‹ˆë‹¤. ìƒˆ í„°ë¯¸ë„ë¡œ ë‹¤ì‹œ ì ‘ì†í•˜ì„¸ìš”.

**ëŠê¸´ í›„ í™•ì¸:**

```bash
sudo tail -100 /var/log/auth.log
# ë˜ëŠ” (RHEL/CentOS)
sudo tail -100 /var/log/secure
```

`Connection closed by ...` ë’¤ì— ë‚˜ì˜¤ëŠ” ì´ìœ (ì˜ˆ: `(disconnected by user)`, `(remote disconnect)`, `(timeout)`)ë¡œ ì›ì¸ì„ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

### 3) OOM ì—¬ë¶€ í™•ì¸

ëŠê¸´ ì§í›„ ë‹¤ì‹œ ì ‘ì†í•´ì„œ:

```bash
dmesg | grep -i "out of memory"
journalctl -k | grep -i oom
```

ë¡œê·¸ê°€ ìˆìœ¼ë©´ ë©”ëª¨ë¦¬ ë¶€ì¡±ìœ¼ë¡œ í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œëœ ê²ƒì…ë‹ˆë‹¤.

---

### ìš”ì•½

| í•­ëª© | ëª…ë ¹/ê²½ë¡œ |
|------|-----------|
| ì£¼ê¸° ìƒíƒœ ë¡œê·¸ | `tail ~/ssh-debug.log` |
| sshd ëŠê¹€ ì‚¬ìœ  | `tail /var/log/auth.log` |
| OOM ë°œìƒ | `dmesg \| grep -i oom` |

---

## ì°¸ê³ 

- **git clone ë°©ì‹**ìœ¼ë¡œ ì „í™˜í•˜ë©´ `git pull` í•œ ë²ˆìœ¼ë¡œ ì—…ë°ì´íŠ¸ ê°€ëŠ¥ (í´ë” êµ¬ì¡°ê°€ ë‹¤ë¦„)
- ìì„¸í•œ Oracle Cloud ì´ˆê¸° ì„¸íŒ…ì€ [Oracle_Cloud_ì„¸íŒ…_ê°€ì´ë“œ.md](./Oracle_Cloud_ì„¸íŒ…_ê°€ì´ë“œ.md) ì°¸ê³ 
