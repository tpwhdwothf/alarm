# 실서버 배포 가이드 (Oracle Cloud + ZIP 방식)

PC에서 코드를 수정한 뒤 실서버에 반영하는 **전체 절차**를 정리한 문서입니다.  
ZIP 방식(wget) 기준으로 작성했습니다.

> **시세 조회만 다른 Oracle 계정으로 옮기고 싶다면**  
> → [시세조회_다른_Oracle로_옮기기_가이드.md](./시세조회_다른_Oracle로_옮기기_가이드.md) 를 순서대로 진행하세요. (비개발자용 단계 정리)

---

## 사전 준비

- GitHub 저장소가 **public** 설정
- SSH 키(`alarm-bot.key`)로 서버 접속 가능
- 서버 IP 주소 확인
- **Supabase 마이그레이션** (아래 "Supabase 마이그레이션" 섹션 확인)

---

## 1단계: PC에서 GitHub에 올리기

### 1-1. 키 파일이 있는 폴더로 이동

```powershell
cd C:\Users\tpwhd\OneDrive\Desktop\코길동
```

> `alarm-bot.key`가 있는 폴더 기준입니다. 프로젝트(`.git`)가 `alarm` 하위 폴더에 있으면 `cd alarm` 추가로 실행하세요.

### 1-2. 변경 사항 커밋 & 푸시

```powershell
git add .
git commit -m "변경 내용 요약"
git push origin main
```

> 기본 브랜치가 `master`면 `git push origin master`로 실행하세요.

---

## 2단계: 서버 SSH 접속

**새 PowerShell 창**을 열고:

```powershell
cd C:\Users\tpwhd\OneDrive\Desktop\코길동
ssh -i alarm-bot.key opc@161.33.212.251
```

> `alarm-bot.key`와 서버 IP를 본인 환경에 맞게 수정하세요.

---

## 3단계 전: PM2 프로세스 중지 (1GB RAM 서버 필수)

1GB RAM 환경에서는 `npm install`과 `npm run build` 시 메모리를 많이 사용합니다.  
봇·워커가 계속 돌아가면 OOM으로 서버가 다운될 수 있으므로, **배포 전에 반드시 중지**하세요.

```bash
npx pm2 stop all
```

- `bot`, `worker-kis`가 중지되며 메모리가 확보됩니다.
- 이후 설치·빌드 단계에서 OOM 위험이 줄어듭니다.

---

## 3단계: 서버에서 최신 코드 받기 (ZIP 방식)

### 3-1. 홈 폴더로 이동

```bash
cd ~
```

### 3-2. GitHub에서 ZIP 다운로드

```bash
wget https://github.com/tpwhdwothf/alarm/archive/refs/heads/main.zip -O alarm-latest.zip
```

> `본인아이디`, `저장소이름`을 실제 GitHub 주소에 맞게 바꾸세요.  
> 브랜치가 `master`면 `master.zip`으로 바꾸세요.

### 3-3. 압축 해제

```bash
unzip -o alarm-latest.zip
```

- 압축 해제 시 `저장소이름-main` 폴더가 생성됩니다 (예: `alarm-main`)

---

## 4단계: 폴더 정리

### 4-1. 기존 alarm 폴더 삭제 및 교체

```bash
rm -rf alarm
mv alarm-main alarm
```

> 풀린 폴더 이름이 `alarm-main`이 아니면 `저장소이름-main`에 맞게 수정하세요.

### 4-2. 프로젝트 폴더로 이동

```bash
cd ~/alarm
```

### 4-3. 내용 확인

```bash
ls -la
```

- `package.json`, `src`, `.env` 등이 보이면 정상입니다.

---

## 5단계: .env 확인

### 5-1. TELEGRAM_ADMIN_IDS 확인

```bash
grep TELEGRAM_ADMIN_IDS .env
```

- 한 줄로 나오면 OK
- 없으면 아래처럼 추가:

```bash
nano .env
```

파일 맨 아래에 추가:

```
TELEGRAM_ADMIN_IDS=본인텔레그램숫자ID
```

- 저장: `Ctrl + O` → Enter
- 종료: `Ctrl + X`

### 5-2. 기존 .env를 다른 폴더에서 복사해야 할 때

```bash
cp ~/alarm-backup/.env ./
```

> 또는 `alarm-old` 등 기존에 .env가 있던 폴더 경로로 수정하세요.

---

## 6단계: 빌드

### 6-1. 의존성 설치

```bash
cd ~/alarm
npm install
```

### 6-2. 권한 오류가 날 때 (tsc: Permission denied)

```bash
chmod +x node_modules/.bin/*
```

### 6-3. TypeScript 빌드

```bash
npm run build
```

- `dist/` 폴더가 생성되거나 갱신되면 성공입니다.

---

## 7단계: PM2 다시 시작

### 7-1. 중지했던 프로세스 다시 시작

```bash
cd ~/alarm
npx pm2 start all
npx pm2 save
```

> 3단계 전에서 `pm2 stop all`로 중지했던 `bot`, `worker-kis`를 다시 시작합니다.  
> 최초 배포거나 PM2 목록이 비어 있으면, 아래처럼 수동으로 시작하세요:  
> `npx pm2 start dist/bot/index.js --name bot`  
> `npx pm2 start dist/worker/kisPriceWorker.js --name worker-kis`  
> `npx pm2 save`

### 7-2. 상태 확인

```bash
npx pm2 status
```

- `bot`, `worker-kis` 둘 다 **online**이면 정상입니다.

---

## 메모리 부족 시 참고 (1GB RAM)

| 상황 | 대응 |
|------|------|
| 배포 중 서버 다운 | 3단계 전에 `npx pm2 stop all` 실행 |
| 설치·빌드 중 OOM | 봇·워커 중지 후 `npm install`, `npm run build` 진행 |

---

## 8단계: 로그 확인 (문제가 있을 때)

### 8-1. 봇 로그

```bash
npx pm2 logs bot
```

### 8-2. 워커 로그

```bash
npx pm2 logs worker-kis
```

### 8-3. 최근 30줄만 보기

```bash
npx pm2 logs bot --lines 30 --nostream
```

---

## 9단계: 부팅 시 자동 실행 (최초 1회만)

서버 재부팅 후에도 봇이 자동으로 켜지게 하려면:

```bash
npx pm2 startup
```

출력되는 `sudo env PATH=... pm2 startup ...` 명령을 **그대로 복사해서** 실행하세요.

---

## 요약 체크리스트

| 순서 | 작업 | 명령 |
|------|------|------|
| 1 | PC에서 push | `git add . && git commit -m "..." && git push origin main` |
| 2 | 서버 접속 | `ssh -i alarm-bot.key opc@서버IP` |
| 3 | **PM2 중지 (1GB 필수)** | `npx pm2 stop all` |
| 4 | ZIP 다운로드 | `wget https://github.com/아이디/저장소/archive/refs/heads/main.zip -O alarm-latest.zip` |
| 5 | 압축 해제 | `unzip -o alarm-latest.zip` |
| 6 | 폴더 정리 | `rm -rf alarm && mv alarm-main alarm` |
| 7 | 설치·빌드 | `cd ~/alarm && npm install && npm run build` |
| 8 | PM2 재시작 | `npx pm2 start all` → `npx pm2 save` |
| 9 | 확인 | `npx pm2 status` |

---

## 시세 조회(워커)만 끄기

봇(명령어 처리)은 켜 두고 **시세 조회(worker-kis)만** 끄고 싶을 때 사용합니다. (메모리 절약·별도 서버로 시세 분리할 때 등)

### 1) 지금 바로 끄기

```bash
cd ~/alarm
npx pm2 stop worker-kis
npx pm2 save
```

- `bot` 은 그대로 동작하고, `worker-kis` 만 중지됩니다.
- `npx pm2 save` 로 저장해 두면, **재부팅 후에도** worker-kis 는 자동으로 올라오지 않고 중지 상태로 남습니다 (PM2가 저장된 목록을 복원할 때 중지된 앱은 그대로 중지).

### 2) 재부팅 시에도 워커가 자동으로 켜지지 않게 하기

**권장: 저장소에 있는 `start-alarm.sh` 사용**

봇만 시작하고 시세 워커는 절대 자동으로 켜지지 않는 스크립트를 저장소에 두었습니다. 서버에서 아래처럼 바꿔 쓰면 됩니다.

```bash
# 1) 스크립트 복사 (최신 코드 받은 뒤)
cp ~/alarm/scripts/server/start-alarm.sh ~/scripts/
chmod +x ~/scripts/start-alarm.sh

# 2) crontab 에서 @reboot 이 이 스크립트를 부르도록 설정
crontab -e
```

`@reboot` 줄을 다음처럼 **한 줄만** 두고, 기존에 `pm2 start all` 이나 워커를 시작하던 내용은 제거합니다.

```text
@reboot /home/opc/scripts/start-alarm.sh >> /home/opc/start-alarm.log 2>&1
```

이렇게 하면 재부팅할 때마다 `start-alarm.sh` 가 실행되면서 **봇만 켜고**, worker-kis 는 중지한 뒤 저장하므로 다음 재부팅 후에도 시세 조회는 자동으로 올라오지 않습니다.

**기존 start-alarm.sh 를 직접 수정하는 경우**

- `cat ~/start-alarm.sh` 로 내용을 확인한 뒤,  
  `pm2 start all` 이면 → `pm2 start bot` 만 쓰거나,  
  봇/워커 두 줄이 있으면 → **봇만 시작하는 줄만 남기고** 워커 시작 줄을 삭제하거나 주석 처리합니다.
- cron @reboot 에서 `pm2 start all` 이면 → 위처럼 `~/scripts/start-alarm.sh` 한 줄로 바꾸는 것을 권장합니다.

### 3) 다시 시세 조회 켜기

원할 때 아래로 다시 켤 수 있습니다.

```bash
cd ~/alarm
npx pm2 start worker-kis
npx pm2 save
```

---

## 봇만 돌릴 때 메모리 줄이기 (시세 조회 끈 상태)

시세 워커를 끄고 **봇만** 쓰는 서버에서 메모리 부담을 조금이라도 줄이고 싶을 때 쓸 수 있습니다.

### 1) 헬스체크 모니터 끄기 (선택)

봇이 2분마다 메모리 사용률을 확인해 85% 이상이면 관리자에게 DM을 보내는 기능을 끌 수 있습니다.  
끄면 그만큼 주기 작업이 사라져 메모리·CPU 부담이 조금 줄어듭니다.

1. 서버에서 `.env` 편집  
   `nano ~/alarm/.env`
2. 아래 한 줄 추가 (또는 이미 있으면 값만 `true` 로)  
   `DISABLE_HEALTH_MONITOR=true`
3. 저장 후 봇만 재시작  
   `npx pm2 restart bot`

- 다시 켜고 싶으면 `.env` 에서 해당 줄을 지우거나 `false` 로 바꾼 뒤 `npx pm2 restart bot` 하면 됩니다.

### 2) Node 메모리 한도 두기 (선택)

봇 프로세스가 쓰는 메모리 상한을 두어, 서버 전체가 한 프로세스에 밀리지 않게 할 수 있습니다.

- PM2로 봇을 시작할 때 `--max-old-space-size` 를 주면 됩니다.  
  예: 384MB 제한  
  `npx pm2 start dist/bot/index.js --name bot --node-args="--max-old-space-size=384"`  
  기존에 `bot` 이 이미 있으면 삭제 후 다시 시작하거나, `ecosystem.config.js` 등에서 `node_args` 로 설정할 수 있습니다.

- 1GB RAM 서버라면 384~512 정도가 무난합니다. 너무 작으면 봇이 동작 중 오류가 날 수 있으니, 로그를 보면서 조정하세요.

---

## 자주 하는 실수

### 1. `cd ~/alarm` 시 "No such file or directory"

- `alarm` 폴더가 아직 없음 → 4단계(폴더 정리)부터 다시 진행
- `ls ~` 로 `alarm-main` 등 풀린 폴더 이름 확인 후 `mv` 진행

### 2. `tsc: Permission denied`

```bash
chmod +x node_modules/.bin/*
```

### 3. PM2 status가 `errored`

- 로그 확인: `npx pm2 logs bot`
- `ProcessContainerFork.js` 관련 에러면 PM2 재설치 후 재시작:

```bash
npm install --save-dev pm2
npx pm2 kill
npx pm2 start dist/bot/index.js --name bot
npx pm2 start dist/worker/kisPriceWorker.js --name worker-kis
npx pm2 save
```

### 4. .env에 새 변수 추가가 필요할 때

```bash
nano .env
```

저장 후 반드시 PM2 재시작:

```bash
npx pm2 restart bot worker-kis
```

---

## Supabase 마이그레이션

코드 배포 전/후에 **Supabase SQL Editor**에서 아래 SQL을 한 번씩 실행해야 할 수 있습니다.

### pick_type 컬럼 추가 (필수)

`/목록`, `/등록` 사용 시 **"Could not find the 'pick_type' column"** 오류가 나면 아래를 실행하세요.

```sql
alter table public.targets
  add column if not exists pick_type text default '무료픽';
```

### buy_price_range 컬럼 추가 (매수가 등록 시)

`/등록` 시 매수가(110000~220000)를 입력하려면 아래를 실행하세요.

```sql
alter table public.targets
  add column if not exists buy_price_range text;
```

### alert_groups 테이블 (필요 시)

`/setgroup 공지방`, `/setgroup VIP`, `/setgroup 일반방` 기능을 쓰려면 아래를 실행하세요.

```sql
create table if not exists public.alert_groups (
  id uuid primary key default gen_random_uuid(),
  created_by text not null,
  group_chat_id text not null,
  role text not null check (role in ('NOTICE', 'VIP', 'GENERAL')),
  created_at timestamptz default now()
);

create unique index alert_groups_created_by_group_chat_id_idx
  on public.alert_groups(created_by, group_chat_id);
```

**기존 alert_groups 테이블이 있다면** (GENERAL role 추가):

```sql
alter table public.alert_groups drop constraint if exists alert_groups_role_check;
alter table public.alert_groups add constraint alert_groups_role_check
  check (role in ('NOTICE', 'VIP', 'GENERAL'));
```

---

## 자주 나오는 Supabase 오류

### 1. "Could not find the 'pick_type' column of 'targets'"

- **원인**: `targets` 테이블에 `pick_type` 컬럼 없음
- **해결**: 위 "pick_type 컬럼 추가" SQL을 Supabase SQL Editor에서 실행

### 2. "/목록" 또는 "/등록" 시 "목록/저장 중 오류가 발생했어요"

- 위 `pick_type` 마이그레이션이 적용되었는지 확인
- Supabase SQL Editor에서 `select * from targets limit 1;` 실행 후 테이블에 `pick_type` 컬럼이 있는지 확인

---

## SSH 끊김 원인 확인

SSH가 자주 끊길 때 원인을 추적하려면 아래 로깅을 설정해 두세요.

> 📋 **확인 방법 (비개발자용)**  
> 끊긴 후 로그를 어떻게 확인하고 해석하는지는 [SSH_끊김_확인_가이드.md](./SSH_끊김_확인_가이드.md)를 참고하세요.

### 1) 시스템 상태 주기 로깅 (권장)

매 3분마다 메모리·부하·SSH 연결 수를 로그에 남깁니다. 끊긴 직전 상태를 확인할 수 있습니다.

**서버에서 실행 (ZIP 배포 후 ~/alarm 안에 스크립트 있음):**

```bash
mkdir -p ~/scripts
cp ~/alarm/scripts/server/ssh-debug-logger.sh ~/scripts/
chmod +x ~/scripts/ssh-debug-logger.sh
```

**cron 등록 (3분마다 실행):**

```bash
crontab -e
```

아래 한 줄 추가 (경로는 실제 경로로 수정):

```
*/3 * * * * /home/opc/scripts/ssh-debug-logger.sh
```

**끊긴 후 다시 접속해서 확인:**

```bash
tail -50 ~/ssh-debug.log
```

`mem=90%` 이상이거나 `free`가 100MB 미만이었으면 OOM 가능성이 높습니다. `ssh=` 개수가 갑자기 줄었으면 연결 끊김 시점을 추정할 수 있습니다.

---

### 2) sshd 상세 로그 (끊김 사유 확인)

SSH가 **왜** 끊겼는지(클라이언트 종료, 타임아웃, 서버 측 오류 등) 상세 로그를 남깁니다.

**서버에서 (sudo 필요):**

```bash
# 현재 LogLevel 확인
grep LogLevel /etc/ssh/sshd_config

# LogLevel을 VERBOSE로 변경
sudo sed -i 's/^#\?LogLevel.*/LogLevel VERBOSE/' /etc/ssh/sshd_config

# sshd 재시작 (접속이 끊겼다가 다시 연결됨)
sudo systemctl restart sshd
```

> ⚠️ `systemctl restart sshd` 실행 시 현재 세션은 끊깁니다. 새 터미널로 다시 접속하세요.

**끊긴 후 확인:**

```bash
sudo tail -100 /var/log/auth.log
# 또는 (RHEL/CentOS)
sudo tail -100 /var/log/secure
```

`Connection closed by ...` 뒤에 나오는 이유(예: `(disconnected by user)`, `(remote disconnect)`, `(timeout)`)로 원인을 파악할 수 있습니다.

---

### 3) OOM 여부 확인

끊긴 직후 다시 접속해서:

```bash
dmesg | grep -i "out of memory"
journalctl -k | grep -i oom
```

로그가 있으면 메모리 부족으로 프로세스가 종료된 것입니다.

---

**끊김 예방(근본 대응):** 서버·클라이언트 SSH keepalive 설정은 [SSH_끊김_확인_가이드.md](./SSH_끊김_확인_가이드.md)의 **「근본적인 대응 (끊김 예방)」** 섹션을 참고하세요.

### 요약

| 항목 | 명령/경로 |
|------|-----------|
| 주기 상태 로그 | `tail ~/ssh-debug.log` |
| sshd 끊김 사유 | `tail /var/log/secure` (또는 auth.log) |
| OOM 발생 | `sudo dmesg \| grep -i oom` |

---

## 참고

- **git clone 방식**으로 전환하면 `git pull` 한 번으로 업데이트 가능 (폴더 구조가 다름)
- 자세한 Oracle Cloud 초기 세팅은 [Oracle_Cloud_세팅_가이드.md](./Oracle_Cloud_세팅_가이드.md) 참고
