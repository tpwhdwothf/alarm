# 실서버 배포 가이드 (Oracle Cloud + ZIP 방식)

PC에서 코드를 수정한 뒤 실서버에 반영하는 **전체 절차**를 정리한 문서입니다.  
ZIP 방식(wget) 기준으로 작성했습니다.

---

## 사전 준비

- GitHub 저장소가 **public** 설정
- SSH 키(`alarm-bot.key`)로 서버 접속 가능
- 서버 IP 주소 확인
- **Supabase 마이그레이션** (아래 "Supabase 마이그레이션" 섹션 확인)

---

## 1단계: PC에서 GitHub에 올리기

### 1-1. 키 파일이 있는 폴더로 이동

```powershell
cd C:\Users\tpwhd\OneDrive\Desktop\코길동
```

> `alarm-bot.key`가 있는 폴더 기준입니다. 프로젝트(`.git`)가 `alarm` 하위 폴더에 있으면 `cd alarm` 추가로 실행하세요.

### 1-2. 변경 사항 커밋 & 푸시

```powershell
git add .
git commit -m "변경 내용 요약"
git push origin main
```

> 기본 브랜치가 `master`면 `git push origin master`로 실행하세요.

---

## 2단계: 서버 SSH 접속

**새 PowerShell 창**을 열고:

```powershell
cd C:\Users\tpwhd\OneDrive\Desktop\코길동
ssh -i alarm-bot.key opc@161.33.212.251
```

> `alarm-bot.key`와 서버 IP를 본인 환경에 맞게 수정하세요.

---

## 3단계 전: PM2 프로세스 중지 (1GB RAM 서버 필수)

1GB RAM 환경에서는 `npm install`과 `npm run build` 시 메모리를 많이 사용합니다.  
봇·워커가 계속 돌아가면 OOM으로 서버가 다운될 수 있으므로, **배포 전에 반드시 중지**하세요.

```bash
npx pm2 stop all
```

- `bot`, `worker-kis`가 중지되며 메모리가 확보됩니다.
- 이후 설치·빌드 단계에서 OOM 위험이 줄어듭니다.

---

## 3단계: 서버에서 최신 코드 받기 (ZIP 방식)

### 3-1. 홈 폴더로 이동

```bash
cd ~
```

### 3-2. GitHub에서 ZIP 다운로드

```bash
wget https://github.com/tpwhdwothf/alarm/archive/refs/heads/main.zip -O alarm-latest.zip
```

> `본인아이디`, `저장소이름`을 실제 GitHub 주소에 맞게 바꾸세요.  
> 브랜치가 `master`면 `master.zip`으로 바꾸세요.

### 3-3. 압축 해제

```bash
unzip -o alarm-latest.zip
```

- 압축 해제 시 `저장소이름-main` 폴더가 생성됩니다 (예: `alarm-main`)

---

## 4단계: 폴더 정리

### 4-1. 기존 alarm 폴더 삭제 및 교체

```bash
rm -rf alarm
mv alarm-main alarm
```

> 풀린 폴더 이름이 `alarm-main`이 아니면 `저장소이름-main`에 맞게 수정하세요.

### 4-2. 프로젝트 폴더로 이동

```bash
cd ~/alarm
```

### 4-3. 내용 확인

```bash
ls -la
```

- `package.json`, `src`, `.env` 등이 보이면 정상입니다.

---

## 5단계: .env 확인

### 5-1. TELEGRAM_ADMIN_IDS 확인

```bash
grep TELEGRAM_ADMIN_IDS .env
```

- 한 줄로 나오면 OK
- 없으면 아래처럼 추가:

```bash
nano .env
```

파일 맨 아래에 추가:

```
TELEGRAM_ADMIN_IDS=본인텔레그램숫자ID
```

- 저장: `Ctrl + O` → Enter
- 종료: `Ctrl + X`

### 5-2. 기존 .env를 다른 폴더에서 복사해야 할 때

```bash
cp ~/alarm-backup/.env ./
```

> 또는 `alarm-old` 등 기존에 .env가 있던 폴더 경로로 수정하세요.

---

## 6단계: 빌드

### 6-1. 의존성 설치

```bash
cd ~/alarm
npm install
```

### 6-2. 권한 오류가 날 때 (tsc: Permission denied)

```bash
chmod +x node_modules/.bin/*
```

### 6-3. TypeScript 빌드

```bash
npm run build
```

- `dist/` 폴더가 생성되거나 갱신되면 성공입니다.

---

## 7단계: PM2 다시 시작

### 7-1. 중지했던 프로세스 다시 시작

```bash
cd ~/alarm
npx pm2 start all
npx pm2 save
```

> 3단계 전에서 `pm2 stop all`로 중지했던 `bot`, `worker-kis`를 다시 시작합니다.  
> 최초 배포거나 PM2 목록이 비어 있으면, 아래처럼 수동으로 시작하세요:  
> `npx pm2 start dist/bot/index.js --name bot`  
> `npx pm2 start dist/worker/kisPriceWorker.js --name worker-kis`  
> `npx pm2 save`

### 7-2. 상태 확인

```bash
npx pm2 status
```

- `bot`, `worker-kis` 둘 다 **online**이면 정상입니다.

---

## 메모리 부족 시 참고 (1GB RAM)

| 상황 | 대응 |
|------|------|
| 배포 중 서버 다운 | 3단계 전에 `npx pm2 stop all` 실행 |
| 설치·빌드 중 OOM | 봇·워커 중지 후 `npm install`, `npm run build` 진행 |

---

## 8단계: 로그 확인 (문제가 있을 때)

### 8-1. 봇 로그

```bash
npx pm2 logs bot
```

### 8-2. 워커 로그

```bash
npx pm2 logs worker-kis
```

### 8-3. 최근 30줄만 보기

```bash
npx pm2 logs bot --lines 30 --nostream
```

---

## 9단계: 부팅 시 자동 실행 (최초 1회만)

서버 재부팅 후에도 봇이 자동으로 켜지게 하려면:

```bash
npx pm2 startup
```

출력되는 `sudo env PATH=... pm2 startup ...` 명령을 **그대로 복사해서** 실행하세요.

---

## 요약 체크리스트

| 순서 | 작업 | 명령 |
|------|------|------|
| 1 | PC에서 push | `git add . && git commit -m "..." && git push origin main` |
| 2 | 서버 접속 | `ssh -i alarm-bot.key opc@서버IP` |
| 3 | **PM2 중지 (1GB 필수)** | `npx pm2 stop all` |
| 4 | ZIP 다운로드 | `wget https://github.com/아이디/저장소/archive/refs/heads/main.zip -O alarm-latest.zip` |
| 5 | 압축 해제 | `unzip -o alarm-latest.zip` |
| 6 | 폴더 정리 | `rm -rf alarm && mv alarm-main alarm` |
| 7 | 설치·빌드 | `cd ~/alarm && npm install && npm run build` |
| 8 | PM2 재시작 | `npx pm2 start all` → `npx pm2 save` |
| 9 | 확인 | `npx pm2 status` |

---

## 자주 하는 실수

### 1. `cd ~/alarm` 시 "No such file or directory"

- `alarm` 폴더가 아직 없음 → 4단계(폴더 정리)부터 다시 진행
- `ls ~` 로 `alarm-main` 등 풀린 폴더 이름 확인 후 `mv` 진행

### 2. `tsc: Permission denied`

```bash
chmod +x node_modules/.bin/*
```

### 3. PM2 status가 `errored`

- 로그 확인: `npx pm2 logs bot`
- `ProcessContainerFork.js` 관련 에러면 PM2 재설치 후 재시작:

```bash
npm install --save-dev pm2
npx pm2 kill
npx pm2 start dist/bot/index.js --name bot
npx pm2 start dist/worker/kisPriceWorker.js --name worker-kis
npx pm2 save
```

### 4. .env에 새 변수 추가가 필요할 때

```bash
nano .env
```

저장 후 반드시 PM2 재시작:

```bash
npx pm2 restart bot worker-kis
```

---

## Supabase 마이그레이션

코드 배포 전/후에 **Supabase SQL Editor**에서 아래 SQL을 한 번씩 실행해야 할 수 있습니다.

### pick_type 컬럼 추가 (필수)

`/목록`, `/등록` 사용 시 **"Could not find the 'pick_type' column"** 오류가 나면 아래를 실행하세요.

```sql
alter table public.targets
  add column if not exists pick_type text default '무료픽';
```

### buy_price_range 컬럼 추가 (매수가 등록 시)

`/등록` 시 매수가(110000~220000)를 입력하려면 아래를 실행하세요.

```sql
alter table public.targets
  add column if not exists buy_price_range text;
```

### alert_groups 테이블 (필요 시)

`/setgroup 공지방`, `/setgroup VIP`, `/setgroup 일반방` 기능을 쓰려면 아래를 실행하세요.

```sql
create table if not exists public.alert_groups (
  id uuid primary key default gen_random_uuid(),
  created_by text not null,
  group_chat_id text not null,
  role text not null check (role in ('NOTICE', 'VIP', 'GENERAL')),
  created_at timestamptz default now()
);

create unique index alert_groups_created_by_group_chat_id_idx
  on public.alert_groups(created_by, group_chat_id);
```

**기존 alert_groups 테이블이 있다면** (GENERAL role 추가):

```sql
alter table public.alert_groups drop constraint if exists alert_groups_role_check;
alter table public.alert_groups add constraint alert_groups_role_check
  check (role in ('NOTICE', 'VIP', 'GENERAL'));
```

---

## 자주 나오는 Supabase 오류

### 1. "Could not find the 'pick_type' column of 'targets'"

- **원인**: `targets` 테이블에 `pick_type` 컬럼 없음
- **해결**: 위 "pick_type 컬럼 추가" SQL을 Supabase SQL Editor에서 실행

### 2. "/목록" 또는 "/등록" 시 "목록/저장 중 오류가 발생했어요"

- 위 `pick_type` 마이그레이션이 적용되었는지 확인
- Supabase SQL Editor에서 `select * from targets limit 1;` 실행 후 테이블에 `pick_type` 컬럼이 있는지 확인

---

## 참고

- **git clone 방식**으로 전환하면 `git pull` 한 번으로 업데이트 가능 (폴더 구조가 다름)
- 자세한 Oracle Cloud 초기 세팅은 [Oracle_Cloud_세팅_가이드.md](./Oracle_Cloud_세팅_가이드.md) 참고
