# KIS OpenAPI 연동 가이드 (국장 + 미장)

이 문서는 **개발을 잘 모르는 분**도 따라 할 수 있도록,  
**한국투자증권 KIS OpenAPI 하나**로 **국내 주식(국장)** 과 **미국 주식(미장)** 시세를 모두 받기 위해 필요한 설정을 단계별로 정리한 것입니다.

---

## 1. 미리 준비할 것

- **한국투자증권 계좌**  
  - 주식 계좌가 있어야 API를 신청·사용할 수 있습니다.  
  - 아직 없다면 [한국투자증권](https://www.koreainvestment.com)에서 계좌 개설 후 진행하세요.

- **개발자 포털 가입**  
  - KIS에서 제공하는 “오픈API”를 쓰려면, **개발자 포털**에 별도로 가입해야 합니다.  
  - 계좌만 있고 포털 가입을 안 하면 API 키를 받을 수 없습니다.

---

## 2. KIS 개발자 포털 접속 및 가입

1. **브라우저**에서 아래 주소로 들어갑니다.  
   - **KIS 개발자 포털**:  
     **https://apiportal.koreainvestment.com**

2. 메뉴에서 **「처음 시작하기」** 또는 **「API 신청」**을 찾아 클릭합니다.

3. 화면 안내에 따라 **회원가입**을 합니다.  
   - 필요한 정보(이메일, 비밀번호 등)를 입력하고 가입을 완료합니다.

4. 가입이 끝나면 **로그인**한 상태로 포털을 사용할 수 있습니다.

---

## 3. 앱 키(App Key)와 앱 시크릿(App Secret) 받기

API를 사용하려면 **앱 키**와 **앱 시크릿** 두 개를 발급받아야 합니다.

1. 개발자 포털에 **로그인**한 상태에서,  
   **「내 애플리케이션」** 또는 **「앱 등록」** 같은 메뉴를 찾습니다.  
   (이름이 조금 다를 수 있지만, “앱/애플리케이션 등록·관리” 역할을 하는 메뉴입니다.)

2. **「새 앱 등록」** 또는 **「앱 생성」**을 선택합니다.

3. **앱 이름**을 입력합니다.  
   - 예: `목표가알림봇`, `주식알림` 등  
   - 나중에 구분하기 쉬운 이름이면 됩니다.

4. 저장(등록)을 하면, 화면에 **두 가지 값**이 나타납니다.  
   - **APP Key** (또는 App Key, Client ID 비슷한 이름)  
   - **APP Secret** (또는 App Secret, Client Secret 비슷한 이름)

5. 이 두 값을 **반드시 어딘가에 복사해 두세요.**  
   - APP Secret은 한 번 보여 주고 다시 안 보여 주는 경우가 있으므로,  
     메모장이나 비밀번호 관리 앱에 붙여 넣어 두는 것이 좋습니다.

> **정확한 메뉴 이름이 기억나지 않을 때**  
> 포털 안의 **「처음 시작하기」**, **「이용 안내」**, **「FAQ」**를 보면  
> “앱 키 발급”, “APP Key 발급” 절차가 그림/단계별로 안내되어 있는 경우가 많습니다.

---

## 4. 계좌번호 확인

- API로 **시세만** 받을 때는 계좌번호가 꼭 필요하지 않을 수 있지만,  
  한국투자증권 API는 보통 **계좌 기준**으로 권한을 주기 때문에,  
  나중에 “실전/모의” 구분이나 WebSocket 연결 시 **계좌번호**를 넣어야 할 수 있습니다.

- **HTS(홈트레이딩) 또는 MTS, 계좌 조회 화면**에서  
  사용 중인 **계좌번호**를 확인해 두세요.  
  (숫자만 있는 10자리 내외입니다.)

---

## 5. 이 프로젝트에서 키 넣는 곳 (.env)

우리 봇/워커는 **환경 변수**로 키를 읽습니다.  
그래서 프로젝트 폴더 안의 **`.env`** 파일에 아래처럼 넣어 두면 됩니다.

1. 프로젝트 최상위 폴더(예: `alarm` 폴더)에서  
   **`.env`** 파일을 엽니다.  
   (없다면 메모장 등으로 새로 만들고, 이름을 정확히 **`.env`**로 저장합니다.)

2. 이미 있는 내용은 그대로 두고, **아래 세 줄을 추가**합니다.  
   `=` 뒤에는 본인이 발급받은 값으로 바꿉니다.

```env
KIS_APP_KEY=여기에_발급받은_APP_Key_붙여넣기
KIS_APP_SECRET=여기에_발급받은_APP_Secret_붙여넣기
KIS_ACCOUNT_NO=여기에_계좌번호_붙여넣기
```

3. **저장**한 뒤,  
   봇이나 워커를 **다시 실행**해야 새 값이 적용됩니다.

> **주의**  
> - `.env` 파일은 **비밀번호처럼 취급**하세요.  
> - 다른 사람에게 보내거나, 인터넷에 올리지 마세요.

---

## 6. KIS 통합 워커 실행 방법 (국장 + 미장)

- 터미널(또는 Cursor 터미널)에서 프로젝트 폴더로 이동한 뒤,  
  아래 명령을 입력해 **국장·미장 모두** 조회하는 **KIS 통합 워커**를 실행합니다.

```bash
npm run worker:kis
```

- **동작 방식**  
  - `KIS_APP_KEY`, `KIS_APP_SECRET`으로 접근 토큰을 발급받고,  
  - 등록된 **국내 종목**은 KIS 국내주식 현재가 API, **미국 종목**은 KIS 해외주식 현재가 API로  
    주기적으로 현재가를 조회합니다.  
  - 목표가에 도달하면 텔레그램 알림이 발송됩니다.

- **실전/모의**  
  - `.env`에서 `KIS_REAL=true`(기본)이면 실전 투자 도메인,  
  - `KIS_REAL=false`로 두면 모의 투자 도메인을 사용합니다.

- **국장만** 쓰는 레거시 스켈레톤은 `npm run worker:kr` 로 실행할 수 있으나,  
  실시간 연동 전에는 시세 수신이 없습니다. **국장·미장 모두 쓸 때는 `worker:kis`만 사용**하면 됩니다.

---

## 7. 문제가 생겼을 때

- **앱 키·시크릿이 안 보인다**  
  → 포털의 「내 애플리케이션」에서 해당 앱을 선택해 “키 다시 보기” 또는 “재발급” 안내를 확인해 보세요.

- **가입·로그인이 안 된다**  
  → KIS 개발자 포털 **FAQ**(https://apiportal.koreainvestment.com/faq) 또는  
  한국투자증권 고객센터에 문의하는 것이 좋습니다.

- **“.env를 수정했는데 반영이 안 된다”**  
  → 봇/워커를 **완전히 종료한 뒤 다시 실행**해 보세요.

---

## 8. 요약 체크리스트

- [ ] 한국투자증권 계좌 있음  
- [ ] KIS 개발자 포털(apiportal.koreainvestment.com) 가입  
- [ ] 포털에서 앱 등록 후 **APP Key**, **APP Secret** 발급·복사  
- [ ] 계좌번호 확인  
- [ ] 프로젝트 `.env`에 `KIS_APP_KEY`, `KIS_APP_SECRET`, `KIS_ACCOUNT_NO` 추가  
- [ ] `npm run worker:kis` 로 KIS 통합 워커(국장+미장) 실행 가능한지 확인  

위 단계까지 끝나면 **KIS 하나로 국장·미장 시세 조회**가 가능합니다.  
`worker:kis`는 REST 현재가 API 폴링 방식으로 동작하며, 같은 키로 국내·해외 주식 모두 조회합니다.
